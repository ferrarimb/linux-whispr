<!DOCTYPE html>
<html lang="en" x-data="app()" x-init="init()" :class="darkMode ? 'dark' : ''">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinuxWhispr Dashboard</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#f5f3ff', 100: '#ede9fe', 200: '#ddd6fe', 300: '#c4b5fd', 400: '#a78bfa', 500: '#8b5cf6', 600: '#7c3aed', 700: '#6d28d9', 800: '#5b21b6', 900: '#4c1d95' }
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
        .fade-in { animation: fadeIn 0.2s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-dot { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.7; } }
        .pulse-dot { animation: pulse-dot 1.5s ease-in-out infinite; }
        .sidebar-item { transition: all 0.15s ease; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-950 text-gray-900 dark:text-gray-100 min-h-screen">

<!-- Layout -->
<div class="flex min-h-screen">

    <!-- Sidebar -->
    <aside class="w-64 bg-white dark:bg-gray-900 border-r border-gray-200 dark:border-gray-800 flex flex-col fixed h-full z-10">
        <!-- Logo -->
        <div class="p-5 border-b border-gray-200 dark:border-gray-800">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 bg-brand-600 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                    </svg>
                </div>
                <div>
                    <h1 class="font-bold text-sm">LinuxWhispr</h1>
                    <p class="text-xs text-gray-500 dark:text-gray-400" x-text="'v' + status.version"></p>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 p-3 space-y-1">
            <template x-for="item in navItems" :key="item.id">
                <button
                    @click="currentPage = item.id"
                    :class="currentPage === item.id
                        ? 'bg-brand-50 dark:bg-brand-900/20 text-brand-700 dark:text-brand-400 border-brand-200 dark:border-brand-800'
                        : 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 border-transparent'"
                    class="sidebar-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium border">
                    <span x-html="item.icon" class="w-5 h-5 flex-shrink-0"></span>
                    <span x-text="item.label"></span>
                </button>
            </template>
        </nav>

        <!-- Dark mode toggle -->
        <div class="p-3 border-t border-gray-200 dark:border-gray-800">
            <button @click="darkMode = !darkMode; localStorage.setItem('darkMode', darkMode)"
                class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800">
                <svg x-show="!darkMode" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
                <svg x-show="darkMode" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                <span x-text="darkMode ? 'Modo Claro' : 'Modo Escuro'"></span>
            </button>
        </div>
    </aside>

    <!-- Main content -->
    <main class="flex-1 ml-64 p-8">

        <!-- Dashboard Page -->
        <div x-show="currentPage === 'dashboard'" x-cloak class="fade-in">
            <h2 class="text-2xl font-bold mb-6">Dashboard</h2>

            <!-- Status Card -->
            <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-3 h-3 rounded-full bg-green-500 pulse-dot"></div>
                        <div>
                            <p class="font-semibold" x-text="status.status === 'running' ? 'Ativo' : 'Inativo'"></p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">LinuxWhispr Daemon</p>
                        </div>
                    </div>
                    <span class="px-3 py-1 bg-brand-50 dark:bg-brand-900/20 text-brand-700 dark:text-brand-400 rounded-full text-xs font-medium" x-text="'v' + status.version"></span>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 p-5">
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Transcrições Hoje</p>
                    <p class="text-3xl font-bold text-brand-600" x-text="stats.today_entries || 0"></p>
                </div>
                <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 p-5">
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Palavras Hoje</p>
                    <p class="text-3xl font-bold text-brand-600" x-text="stats.today_words || 0"></p>
                </div>
                <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 p-5">
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Total de Transcrições</p>
                    <p class="text-3xl font-bold text-brand-600" x-text="stats.total_entries || 0"></p>
                </div>
                <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 p-5">
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Duração Média</p>
                    <p class="text-3xl font-bold text-brand-600" x-text="(stats.avg_duration || 0) + 's'"></p>
                </div>
            </div>

            <!-- Recent Transcriptions -->
            <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800">
                <div class="p-5 border-b border-gray-200 dark:border-gray-800">
                    <h3 class="font-semibold">Transcrições Recentes</h3>
                </div>
                <div class="divide-y divide-gray-100 dark:divide-gray-800">
                    <template x-for="entry in recentHistory" :key="entry.id">
                        <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                            <p class="text-sm mb-1" x-text="entry.raw_text.substring(0, 120) + (entry.raw_text.length > 120 ? '...' : '')"></p>
                            <div class="flex items-center gap-3 text-xs text-gray-500 dark:text-gray-400">
                                <span x-text="formatDate(entry.timestamp)"></span>
                                <span>&middot;</span>
                                <span x-text="entry.word_count + ' palavras'"></span>
                                <span x-show="entry.app_context">&middot;</span>
                                <span x-show="entry.app_context" x-text="entry.app_context"></span>
                            </div>
                        </div>
                    </template>
                    <div x-show="recentHistory.length === 0" class="p-8 text-center text-gray-400">
                        Nenhuma transcrição ainda
                    </div>
                </div>
            </div>
        </div>

        <!-- Config Page -->
        <div x-show="currentPage === 'config'" x-cloak class="fade-in">
            <h2 class="text-2xl font-bold mb-6">Configurações</h2>

            <!-- Config sections -->
            <div class="space-y-4">
                <!-- STT Section -->
                <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800">
                    <button @click="configOpen.stt = !configOpen.stt" class="w-full flex items-center justify-between p-5">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-brand-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
                            <span class="font-semibold">Transcrição (STT)</span>
                        </div>
                        <svg :class="configOpen.stt ? 'rotate-180' : ''" class="w-5 h-5 text-gray-400 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <div x-show="configOpen.stt" x-collapse class="px-5 pb-5 space-y-4 border-t border-gray-100 dark:border-gray-800 pt-4">
                        <div>
                            <label class="block text-sm font-medium mb-1.5">Backend STT</label>
                            <select x-model="config.stt.backend" @change="saveConfig()" class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm">
                                <option value="faster-whisper">faster-whisper (Local)</option>
                                <option value="openai">OpenAI Whisper API</option>
                                <option value="groq">Groq Whisper API</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1.5">Modelo Whisper</label>
                            <select x-model="config.stt.model" @change="saveConfig()" class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm">
                                <option value="tiny">tiny (~75MB)</option>
                                <option value="base">base (~150MB)</option>
                                <option value="small">small (~500MB)</option>
                                <option value="medium">medium (~1.5GB)</option>
                                <option value="large-v3">large-v3 (~3.1GB)</option>
                                <option value="large-v3-turbo">large-v3-turbo (~1.6GB)</option>
                                <option value="distil-large-v3">distil-large-v3 (~1.5GB)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1.5">Idioma</label>
                            <select x-model="config.stt.language" @change="saveConfig()" class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm">
                                <option value="auto">Auto-detectar</option>
                                <option value="pt">Português</option>
                                <option value="en">English</option>
                                <option value="es">Español</option>
                                <option value="fr">Français</option>
                                <option value="de">Deutsch</option>
                                <option value="it">Italiano</option>
                                <option value="ja">日本語</option>
                                <option value="zh">中文</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1.5">Dispositivo de Computação</label>
                            <select x-model="config.stt.device" @change="saveConfig()" class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm">
                                <option value="auto">Auto</option>
                                <option value="cpu">CPU</option>
                                <option value="cuda">CUDA (GPU)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1.5">Tipo de Computação</label>
                            <select x-model="config.stt.compute_type" @change="saveConfig()" class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm">
                                <option value="auto">Auto</option>
                                <option value="float16">float16</option>
                                <option value="int8">int8</option>
                                <option value="float32">float32</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Audio Section -->
                <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800">
                    <button @click="configOpen.audio = !configOpen.audio" class="w-full flex items-center justify-between p-5">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-brand-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/></svg>
                            <span class="font-semibold">Áudio</span>
                        </div>
                        <svg :class="configOpen.audio ? 'rotate-180' : ''" class="w-5 h-5 text-gray-400 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <div x-show="configOpen.audio" x-collapse class="px-5 pb-5 space-y-4 border-t border-gray-100 dark:border-gray-800 pt-4">
                        <div>
                            <label class="block text-sm font-medium mb-1.5">Duração do Silêncio (s)</label>
                            <input type="range" min="0.5" max="10" step="0.5" x-model="config.audio.silence_duration" @change="saveConfig()" class="w-full">
                            <span class="text-sm text-gray-500" x-text="config.audio.silence_duration + 's'"></span>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1.5">Sensibilidade VAD</label>
                            <input type="range" min="0.1" max="0.9" step="0.05" x-model="config.audio.silence_threshold" @change="saveConfig()" class="w-full">
                            <span class="text-sm text-gray-500" x-text="config.audio.silence_threshold"></span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium">Modo Sussurro</p>
                                <p class="text-xs text-gray-500">Aumentar ganho para ambientes silenciosos</p>
                            </div>
                            <button @click="config.audio.whisper_mode = !config.audio.whisper_mode; saveConfig()"
                                :class="config.audio.whisper_mode ? 'bg-brand-600' : 'bg-gray-300 dark:bg-gray-600'"
                                class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors">
                                <span :class="config.audio.whisper_mode ? 'translate-x-6' : 'translate-x-1'" class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"></span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- AI Section -->
                <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800">
                    <button @click="configOpen.ai = !configOpen.ai" class="w-full flex items-center justify-between p-5">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-brand-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082M19.8 15.3l-1.57.393A9.065 9.065 0 0112 15a9.065 9.065 0 00-6.23.693L5 14.5m14.8.8l1.402 1.402c1.232 1.232.65 3.318-1.067 3.611A48.309 48.309 0 0112 21c-2.773 0-5.491-.235-8.135-.687-1.718-.293-2.3-2.379-1.067-3.61L5 14.5"/></svg>
                            <span class="font-semibold">Refinamento AI</span>
                        </div>
                        <svg :class="configOpen.ai ? 'rotate-180' : ''" class="w-5 h-5 text-gray-400 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <div x-show="configOpen.ai" x-collapse class="px-5 pb-5 space-y-4 border-t border-gray-100 dark:border-gray-800 pt-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium">Ativar Refinamento AI</p>
                                <p class="text-xs text-gray-500">Limpar texto, corrigir gramática, formatar por contexto</p>
                            </div>
                            <button @click="config.ai.enabled = !config.ai.enabled; saveConfig()"
                                :class="config.ai.enabled ? 'bg-brand-600' : 'bg-gray-300 dark:bg-gray-600'"
                                class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors">
                                <span :class="config.ai.enabled ? 'translate-x-6' : 'translate-x-1'" class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"></span>
                            </button>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1.5">Backend LLM</label>
                            <select x-model="config.ai.backend" @change="saveConfig()" class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm">
                                <option value="none">Nenhum</option>
                                <option value="openai">OpenAI</option>
                                <option value="groq">Groq</option>
                                <option value="anthropic">Anthropic</option>
                                <option value="local">Local (llama.cpp)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1.5">Modelo</label>
                            <input type="text" x-model="config.ai.model" @change="saveConfig()" placeholder="ex: gpt-4o-mini" class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1.5">Prompt Personalizado</label>
                            <textarea x-model="config.ai.custom_prompt" @change="saveConfig()" rows="3" placeholder="Deixe vazio para usar o padrão" class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Hotkey Section -->
                <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800">
                    <button @click="configOpen.hotkey = !configOpen.hotkey" class="w-full flex items-center justify-between p-5">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-brand-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                            <span class="font-semibold">Atalhos de Teclado</span>
                        </div>
                        <svg :class="configOpen.hotkey ? 'rotate-180' : ''" class="w-5 h-5 text-gray-400 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <div x-show="configOpen.hotkey" x-collapse class="px-5 pb-5 space-y-4 border-t border-gray-100 dark:border-gray-800 pt-4">
                        <div>
                            <label class="block text-sm font-medium mb-1.5">Hotkey de Ditado</label>
                            <input type="text" x-model="config.hotkey.dictation" @change="saveConfig()" class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm font-mono">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1.5">Hotkey de Comando</label>
                            <input type="text" x-model="config.hotkey.command" @change="saveConfig()" class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm font-mono">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1.5">Modo de Ativação</label>
                            <select x-model="config.hotkey.mode" @change="saveConfig()" class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm">
                                <option value="toggle">Toggle</option>
                                <option value="push-to-talk">Push-to-Talk</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Injection Section -->
                <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800">
                    <button @click="configOpen.injection = !configOpen.injection" class="w-full flex items-center justify-between p-5">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-brand-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                            <span class="font-semibold">Injeção de Texto</span>
                        </div>
                        <svg :class="configOpen.injection ? 'rotate-180' : ''" class="w-5 h-5 text-gray-400 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <div x-show="configOpen.injection" x-collapse class="px-5 pb-5 space-y-4 border-t border-gray-100 dark:border-gray-800 pt-4">
                        <div>
                            <label class="block text-sm font-medium mb-1.5">Método</label>
                            <select x-model="config.injection.method" @change="saveConfig()" class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm">
                                <option value="auto">Auto</option>
                                <option value="wtype">wtype (Wayland)</option>
                                <option value="xdotool">xdotool (X11)</option>
                                <option value="ydotool">ydotool (Wayland)</option>
                                <option value="clipboard-only">Clipboard Only</option>
                            </select>
                        </div>
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium">Preservar Clipboard</p>
                                <p class="text-xs text-gray-500">Restaurar conteúdo anterior após injeção</p>
                            </div>
                            <button @click="config.injection.preserve_clipboard = !config.injection.preserve_clipboard; saveConfig()"
                                :class="config.injection.preserve_clipboard ? 'bg-brand-600' : 'bg-gray-300 dark:bg-gray-600'"
                                class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors">
                                <span :class="config.injection.preserve_clipboard ? 'translate-x-6' : 'translate-x-1'" class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"></span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- History Config Section -->
                <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800">
                    <button @click="configOpen.historyConf = !configOpen.historyConf" class="w-full flex items-center justify-between p-5">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-brand-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            <span class="font-semibold">Histórico & Adaptativo</span>
                        </div>
                        <svg :class="configOpen.historyConf ? 'rotate-180' : ''" class="w-5 h-5 text-gray-400 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <div x-show="configOpen.historyConf" x-collapse class="px-5 pb-5 space-y-4 border-t border-gray-100 dark:border-gray-800 pt-4">
                        <div>
                            <label class="block text-sm font-medium mb-1.5">Retenção (dias)</label>
                            <input type="number" min="1" max="365" x-model.number="config.history.retention_days" @change="saveConfig()" class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm">
                        </div>
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium">Aprendizado Adaptativo</p>
                                <p class="text-xs text-gray-500">Aprender correções automaticamente</p>
                            </div>
                            <button @click="config.adaptive.enabled = !config.adaptive.enabled; saveConfig()"
                                :class="config.adaptive.enabled ? 'bg-brand-600' : 'bg-gray-300 dark:bg-gray-600'"
                                class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors">
                                <span :class="config.adaptive.enabled ? 'translate-x-6' : 'translate-x-1'" class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"></span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Save/Reset Actions -->
                <div class="flex gap-3 pt-2">
                    <button @click="if(confirm('Resetar todas as configurações para os valores padrão?')) resetConfig()"
                        class="px-4 py-2 bg-red-100 dark:bg-red-900/20 text-red-700 dark:text-red-400 rounded-lg text-sm font-medium hover:bg-red-200 dark:hover:bg-red-900/30 transition-colors">
                        Resetar para Padrão
                    </button>
                </div>
            </div>
        </div>

        <!-- History Page -->
        <div x-show="currentPage === 'history'" x-cloak class="fade-in">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold">Histórico de Transcrições</h2>
                <div class="flex items-center gap-3">
                    <a href="/api/history/export" class="px-3 py-2 bg-brand-100 dark:bg-brand-900/20 text-brand-700 dark:text-brand-400 rounded-lg text-sm font-medium hover:bg-brand-200 transition-colors">Exportar JSON</a>
                    <button @click="if(confirm('Limpar TODO o histórico?')) clearHistory()"
                        class="px-3 py-2 bg-red-100 dark:bg-red-900/20 text-red-700 dark:text-red-400 rounded-lg text-sm font-medium hover:bg-red-200 transition-colors">Limpar Tudo</button>
                </div>
            </div>

            <!-- Search -->
            <div class="mb-4">
                <input type="text" x-model="historySearch" @input.debounce.300ms="loadHistory()"
                    placeholder="Buscar transcrições..."
                    class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-4 py-2.5 text-sm">
            </div>

            <!-- History Table -->
            <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 dark:bg-gray-800/50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Texto</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Palavras</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duração</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">App</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100 dark:divide-gray-800">
                            <template x-for="entry in historyEntries" :key="entry.id">
                                <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                                    <td class="px-4 py-3 text-sm text-gray-500 whitespace-nowrap" x-text="formatDate(entry.timestamp)"></td>
                                    <td class="px-4 py-3 text-sm max-w-md">
                                        <p class="truncate" x-text="entry.refined_text || entry.raw_text"></p>
                                        <p x-show="entry.refined_text" class="text-xs text-gray-400 truncate mt-0.5" x-text="'Original: ' + entry.raw_text"></p>
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-500" x-text="entry.word_count"></td>
                                    <td class="px-4 py-3 text-sm text-gray-500" x-text="entry.duration.toFixed(1) + 's'"></td>
                                    <td class="px-4 py-3 text-sm text-gray-500 max-w-[120px] truncate" x-text="entry.app_context || '-'"></td>
                                    <td class="px-4 py-3 text-sm">
                                        <div class="flex items-center gap-2">
                                            <button @click="copyToClipboard(entry.refined_text || entry.raw_text)" class="text-brand-600 hover:text-brand-800 dark:text-brand-400" title="Copiar">
                                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                            </button>
                                            <button @click="deleteHistoryEntry(entry.id)" class="text-red-500 hover:text-red-700" title="Excluir">
                                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
                <div x-show="historyEntries.length === 0" class="p-8 text-center text-gray-400">Nenhuma transcrição encontrada</div>

                <!-- Pagination -->
                <div x-show="historyTotal > historyLimit" class="flex items-center justify-between px-4 py-3 border-t border-gray-100 dark:border-gray-800">
                    <span class="text-sm text-gray-500" x-text="`${historyTotal} transcrição(ões)`"></span>
                    <div class="flex gap-2">
                        <button @click="historyPage > 1 && (historyPage--, loadHistory())"
                            :disabled="historyPage <= 1"
                            :class="historyPage <= 1 ? 'opacity-50 cursor-not-allowed' : ''"
                            class="px-3 py-1.5 text-sm bg-gray-100 dark:bg-gray-800 rounded-lg">Anterior</button>
                        <span class="px-3 py-1.5 text-sm" x-text="'Página ' + historyPage"></span>
                        <button @click="historyHasMore && (historyPage++, loadHistory())"
                            :disabled="!historyHasMore"
                            :class="!historyHasMore ? 'opacity-50 cursor-not-allowed' : ''"
                            class="px-3 py-1.5 text-sm bg-gray-100 dark:bg-gray-800 rounded-lg">Próxima</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dictionary Page -->
        <div x-show="currentPage === 'dictionary'" x-cloak class="fade-in">
            <h2 class="text-2xl font-bold mb-6">Dicionário Personalizado</h2>

            <!-- Add Word -->
            <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 p-5 mb-6">
                <h3 class="font-semibold mb-3">Adicionar Palavra</h3>
                <div class="flex gap-3">
                    <input type="text" x-model="newWord" placeholder="Palavra ou termo" class="flex-1 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm" @keydown.enter="addWord()">
                    <select x-model="newWordCategory" class="rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm">
                        <option value="general">Geral</option>
                        <option value="personal_names">Nomes Pessoais</option>
                        <option value="technical">Técnico</option>
                        <option value="brand">Marca</option>
                    </select>
                    <button @click="addWord()" class="px-4 py-2 bg-brand-600 text-white rounded-lg text-sm font-medium hover:bg-brand-700 transition-colors">Adicionar</button>
                </div>
            </div>

            <!-- Words Table -->
            <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 overflow-hidden mb-6">
                <div class="p-5 border-b border-gray-100 dark:border-gray-800">
                    <h3 class="font-semibold">Palavras <span class="text-gray-400 font-normal" x-text="'(' + dictionary.entries.length + ')'"></span></h3>
                </div>
                <table class="w-full">
                    <thead class="bg-gray-50 dark:bg-gray-800/50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Palavra</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fonte</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Categoria</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Frequência</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ações</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 dark:divide-gray-800">
                        <template x-for="entry in dictionary.entries" :key="entry.word">
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50">
                                <td class="px-4 py-3 text-sm font-medium" x-text="entry.word"></td>
                                <td class="px-4 py-3 text-sm text-gray-500">
                                    <span :class="entry.source === 'manual' ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400' : 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400'"
                                        class="px-2 py-0.5 rounded-full text-xs" x-text="entry.source"></span>
                                </td>
                                <td class="px-4 py-3 text-sm text-gray-500" x-text="entry.category"></td>
                                <td class="px-4 py-3 text-sm text-gray-500" x-text="entry.frequency"></td>
                                <td class="px-4 py-3">
                                    <button @click="removeWord(entry.word)" class="text-red-500 hover:text-red-700">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
                <div x-show="dictionary.entries.length === 0" class="p-8 text-center text-gray-400">Nenhuma palavra no dicionário</div>
            </div>

            <!-- Corrections Table -->
            <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 overflow-hidden">
                <div class="p-5 border-b border-gray-100 dark:border-gray-800">
                    <h3 class="font-semibold">Correções Aprendidas <span class="text-gray-400 font-normal" x-text="'(' + dictionary.corrections.length + ')'"></span></h3>
                </div>
                <table class="w-full">
                    <thead class="bg-gray-50 dark:bg-gray-800/50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ouvido</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Corrigido</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vezes</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Última vez</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ações</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 dark:divide-gray-800">
                        <template x-for="(corr, index) in dictionary.corrections" :key="index">
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50">
                                <td class="px-4 py-3 text-sm text-red-500 line-through" x-text="corr.heard"></td>
                                <td class="px-4 py-3 text-sm text-green-600 font-medium" x-text="corr.corrected"></td>
                                <td class="px-4 py-3 text-sm text-gray-500" x-text="corr.count"></td>
                                <td class="px-4 py-3 text-sm text-gray-500" x-text="formatDate(corr.last_seen)"></td>
                                <td class="px-4 py-3">
                                    <button @click="removeCorrection(index)" class="text-red-500 hover:text-red-700">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
                <div x-show="dictionary.corrections.length === 0" class="p-8 text-center text-gray-400">Nenhuma correção aprendida</div>
            </div>
        </div>

        <!-- Snippets Page -->
        <div x-show="currentPage === 'snippets'" x-cloak class="fade-in">
            <h2 class="text-2xl font-bold mb-6">Atalhos de Voz (Snippets)</h2>

            <!-- Add Snippet -->
            <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 p-5 mb-6">
                <h3 class="font-semibold mb-3">Adicionar Snippet</h3>
                <div class="flex gap-3">
                    <input type="text" x-model="newSnippetTrigger" placeholder="Frase gatilho (ex: meu email)" class="flex-1 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm" @keydown.enter="addSnippet()">
                    <input type="text" x-model="newSnippetExpansion" placeholder="Expansão (ex: joao@email.com)" class="flex-1 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-2 text-sm" @keydown.enter="addSnippet()">
                    <button @click="addSnippet()" class="px-4 py-2 bg-brand-600 text-white rounded-lg text-sm font-medium hover:bg-brand-700 transition-colors">Adicionar</button>
                </div>
            </div>

            <!-- Snippets Table -->
            <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-50 dark:bg-gray-800/50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Gatilho</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Expansão</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ações</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 dark:divide-gray-800">
                        <template x-for="snippet in snippets" :key="snippet.trigger">
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50">
                                <td class="px-4 py-3 text-sm font-mono bg-gray-50 dark:bg-gray-800/30" x-text="snippet.trigger"></td>
                                <td class="px-4 py-3 text-sm" x-text="snippet.expansion"></td>
                                <td class="px-4 py-3">
                                    <button @click="removeSnippet(snippet.trigger)" class="text-red-500 hover:text-red-700">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
                <div x-show="snippets.length === 0" class="p-8 text-center text-gray-400">Nenhum snippet configurado</div>
            </div>
        </div>

        <!-- Models Page -->
        <div x-show="currentPage === 'models'" x-cloak class="fade-in">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold">Modelos Whisper</h2>
                <div class="px-3 py-1.5 bg-gray-100 dark:bg-gray-800 rounded-lg text-sm text-gray-600 dark:text-gray-400" x-text="'Uso total: ' + diskUsage.mb + ' MB'"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <template x-for="model in models" :key="model.name">
                    <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-800 p-5"
                         :class="model.active ? 'ring-2 ring-brand-500' : ''">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold" x-text="model.name"></h3>
                            <span x-show="model.active" class="px-2 py-0.5 bg-brand-100 dark:bg-brand-900/20 text-brand-700 dark:text-brand-400 rounded-full text-xs font-medium">Ativo</span>
                        </div>
                        <p class="text-sm text-gray-500 mb-4" x-text="'~' + model.size_mb + ' MB'"></p>
                        <div class="flex items-center justify-between">
                            <span :class="model.downloaded ? 'text-green-600' : 'text-gray-400'" class="text-sm flex items-center gap-1">
                                <svg x-show="model.downloaded" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
                                <span x-text="model.downloaded ? 'Baixado' : 'Não baixado'"></span>
                            </span>
                            <div class="flex gap-2">
                                <button x-show="!model.downloaded" @click="downloadModel(model.name)"
                                    :disabled="model.downloading"
                                    class="px-3 py-1.5 bg-brand-600 text-white rounded-lg text-xs font-medium hover:bg-brand-700 transition-colors disabled:opacity-50">
                                    <span x-show="!model.downloading">Baixar</span>
                                    <span x-show="model.downloading">Baixando...</span>
                                </button>
                                <button x-show="model.downloaded && !model.active" @click="deleteModel(model.name)"
                                    class="px-3 py-1.5 bg-red-100 dark:bg-red-900/20 text-red-700 dark:text-red-400 rounded-lg text-xs font-medium hover:bg-red-200 transition-colors">
                                    Excluir
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

    </main>
</div>

<!-- Toast Notifications -->
<div x-show="toast.show" x-transition class="fixed bottom-6 right-6 z-50">
    <div :class="toast.type === 'success' ? 'bg-green-600' : toast.type === 'error' ? 'bg-red-600' : 'bg-brand-600'"
         class="text-white px-4 py-3 rounded-lg shadow-lg text-sm max-w-sm">
        <span x-text="toast.message"></span>
    </div>
</div>

<script>
function app() {
    return {
        darkMode: localStorage.getItem('darkMode') === 'true' || true,
        currentPage: 'dashboard',
        toast: { show: false, message: '', type: 'success' },

        // Nav items
        navItems: [
            { id: 'dashboard', label: 'Dashboard', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>' },
            { id: 'config', label: 'Configurações', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>' },
            { id: 'history', label: 'Histórico', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>' },
            { id: 'dictionary', label: 'Dicionário', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>' },
            { id: 'snippets', label: 'Snippets', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>' },
            { id: 'models', label: 'Modelos', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"/></svg>' },
        ],

        // Data
        status: { version: '...', status: 'loading' },
        stats: {},
        config: { audio: {}, stt: {}, ai: {}, hotkey: {}, injection: {}, history: {}, adaptive: {} },
        configOpen: { stt: false, audio: false, ai: false, hotkey: false, injection: false, historyConf: false },
        historyEntries: [],
        historySearch: '',
        historyPage: 1,
        historyLimit: 20,
        historyTotal: 0,
        historyHasMore: false,
        recentHistory: [],
        dictionary: { entries: [], corrections: [] },
        snippets: [],
        models: [],
        diskUsage: { mb: 0 },
        newWord: '',
        newWordCategory: 'general',
        newSnippetTrigger: '',
        newSnippetExpansion: '',

        async init() {
            if (localStorage.getItem('darkMode') === null) {
                this.darkMode = true;
            }
            await Promise.all([
                this.loadStatus(),
                this.loadStats(),
                this.loadConfig(),
                this.loadHistory(),
                this.loadRecentHistory(),
                this.loadDictionary(),
                this.loadSnippets(),
                this.loadModels(),
                this.loadDiskUsage(),
            ]);
        },

        showToast(message, type = 'success') {
            this.toast = { show: true, message, type };
            setTimeout(() => this.toast.show = false, 3000);
        },

        formatDate(ts) {
            if (!ts) return '';
            const d = new Date(ts);
            return d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        },

        async copyToClipboard(text) {
            await navigator.clipboard.writeText(text);
            this.showToast('Copiado para o clipboard!');
        },

        // API helpers
        async api(url, opts = {}) {
            try {
                const res = await fetch(url, {
                    headers: { 'Content-Type': 'application/json' },
                    ...opts,
                });
                return await res.json();
            } catch (e) {
                this.showToast('Erro de conexão com o servidor', 'error');
                return null;
            }
        },

        // Loaders
        async loadStatus() { const d = await this.api('/api/status'); if (d) this.status = d; },
        async loadStats() { const d = await this.api('/api/history/stats'); if (d) this.stats = d; },
        async loadConfig() { const d = await this.api('/api/config'); if (d) this.config = d; },

        async loadHistory() {
            const q = this.historySearch ? `&q=${encodeURIComponent(this.historySearch)}` : '';
            const d = await this.api(`/api/history?page=${this.historyPage}&limit=${this.historyLimit}${q}`);
            if (d) {
                this.historyEntries = d.entries;
                this.historyTotal = d.total;
                this.historyHasMore = d.has_more;
            }
        },

        async loadRecentHistory() {
            const d = await this.api('/api/history?page=1&limit=5');
            if (d) this.recentHistory = d.entries;
        },

        async loadDictionary() { const d = await this.api('/api/dictionary'); if (d) this.dictionary = d; },
        async loadSnippets() { const d = await this.api('/api/snippets'); if (d) this.snippets = d.snippets; },
        async loadModels() { const d = await this.api('/api/models'); if (d) this.models = d.models.map(m => ({...m, downloading: false})); },
        async loadDiskUsage() { const d = await this.api('/api/models/disk-usage'); if (d) this.diskUsage = d; },

        // Config
        async saveConfig() {
            const d = await this.api('/api/config', { method: 'PUT', body: JSON.stringify(this.config) });
            if (d && d.status === 'ok') this.showToast('Configuração salva!');
        },

        async resetConfig() {
            await this.api('/api/config/reset', { method: 'POST' });
            await this.loadConfig();
            this.showToast('Configuração resetada para os padrões');
        },

        // History
        async deleteHistoryEntry(id) {
            const d = await this.api(`/api/history/${id}`, { method: 'DELETE' });
            if (d && d.status === 'ok') { this.showToast('Transcrição excluída'); await this.loadHistory(); await this.loadStats(); }
        },

        async clearHistory() {
            const d = await this.api('/api/history', { method: 'DELETE' });
            if (d && d.status === 'ok') { this.showToast(d.message); await this.loadHistory(); await this.loadStats(); await this.loadRecentHistory(); }
        },

        // Dictionary
        async addWord() {
            if (!this.newWord.trim()) return;
            const d = await this.api('/api/dictionary/words', { method: 'POST', body: JSON.stringify({ word: this.newWord, category: this.newWordCategory }) });
            if (d && d.status === 'ok') { this.showToast(d.message); this.newWord = ''; await this.loadDictionary(); }
        },

        async removeWord(word) {
            const d = await this.api(`/api/dictionary/words/${encodeURIComponent(word)}`, { method: 'DELETE' });
            if (d && d.status === 'ok') { this.showToast(d.message); await this.loadDictionary(); }
        },

        async removeCorrection(index) {
            const d = await this.api(`/api/dictionary/corrections/${index}`, { method: 'DELETE' });
            if (d && d.status === 'ok') { this.showToast(d.message); await this.loadDictionary(); }
        },

        // Snippets
        async addSnippet() {
            if (!this.newSnippetTrigger.trim() || !this.newSnippetExpansion.trim()) return;
            const d = await this.api('/api/snippets', { method: 'POST', body: JSON.stringify({ trigger: this.newSnippetTrigger, expansion: this.newSnippetExpansion }) });
            if (d && d.status === 'ok') { this.showToast(d.message); this.newSnippetTrigger = ''; this.newSnippetExpansion = ''; await this.loadSnippets(); }
        },

        async removeSnippet(trigger) {
            const d = await this.api(`/api/snippets/${encodeURIComponent(trigger)}`, { method: 'DELETE' });
            if (d && d.status === 'ok') { this.showToast(d.message); await this.loadSnippets(); }
        },

        // Models
        async downloadModel(name) {
            const model = this.models.find(m => m.name === name);
            if (model) model.downloading = true;
            this.showToast(`Iniciando download do modelo '${name}'...`, 'info');
            const d = await this.api(`/api/models/${name}/download`, { method: 'POST' });
            if (model) model.downloading = false;
            if (d && d.status === 'ok') { this.showToast(d.message); await this.loadModels(); await this.loadDiskUsage(); }
            else if (d) { this.showToast(d.message, 'error'); }
        },

        async deleteModel(name) {
            if (!confirm(`Excluir o modelo '${name}'?`)) return;
            const d = await this.api(`/api/models/${name}`, { method: 'DELETE' });
            if (d && d.status === 'ok') { this.showToast(d.message); await this.loadModels(); await this.loadDiskUsage(); }
        },
    };
}
</script>

</body>
</html>
